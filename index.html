<script>
  const pares = ["BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT"];
  const domingo = {
    BTCUSDT:{max:67000,min:65000},
    ETHUSDT:{max:3500,min:3420},
    BNBUSDT:{max:450,min:430},
    SOLUSDT:{max:150,min:142},
    XRPUSDT:{max:0.55,min:0.51}
  };

  // Proxy que a√±ade el header CORS para permitir requests a Binance
  const proxy = url => 'https://thingproxy.freeboard.io/fetch/' + url;

  let dataGlobal = [], alerted = new Set();

  async function actualizar() {
    const resultados = [];
    for (let par of pares) {
      try {
        // 1) Precio
        const p = await fetch(proxy(`https://api.binance.com/api/v3/ticker/price?symbol=${par}`))
                          .then(r => r.json());
        const precio = parseFloat(p.price);

        // 2) Velas 1h (15 cierres)
        const kl = await fetch(proxy(
          `https://api.binance.com/api/v3/klines?symbol=${par}&interval=1h&limit=15`
        )).then(r => r.json());
        const cierres = kl.map(k => parseFloat(k[4]));

        // 3) C√°lculo EMA28 y RSI14
        const ema = calcEMA(cierres, 28);
        const rsi = calcRSI(cierres);

        // 4) √çndice OnTrader
        const {max,min} = domingo[par];
        let score = 0;
        if (precio > min) score += 1;
        if (precio > (min + max)/2) score += 2;
        if (precio > max) score += 2;
        if (precio < min) score += 2;
        if ((precio % 1) < 0.2) score += 1;
        if (precio > ema) score += 2;
        if (rsi > 60 || rsi < 40) score += 2.5;
        score = Math.min(10, Math.max(1, score));

        // 5) Alerta
        const alerta = score >= 7
          ? `üö® ${par.replace('USDT','')} √çndice ${score}`
          : '-';

        resultados.push({cripto: par.replace('USDT',''), precio, indice: score, alerta});
      } catch(e) {
        console.warn('Fetch error', par, e);
      }
    }
    dataGlobal = resultados;
    renderTabla();
    mostrarAlerta();
  }

  function calcEMA(vals, period) {
    const k = 2/(period + 1);
    return vals.reduce((acc, v, i) => i
      ? v * k + acc * (1 - k)
      : v
    );
  }

  function calcRSI(c) {
    let gains = 0, losses = 0;
    for (let i = 1; i < c.length; i++) {
      const d = c[i] - c[i-1];
      if (d > 0) gains += d;
      else losses -= d;
    }
    const avgG = gains/(c.length - 1);
    const avgL = losses/(c.length - 1) || 1e-6;
    const rs = avgG/avgL;
    return 100 - (100/(1 + rs));
  }

  function renderTabla() {
    const ord = document.getElementById('orden').value;
    const bus = document.getElementById('buscar').value.toLowerCase();
    let arr = dataGlobal.filter(d => d.cripto.toLowerCase().includes(bus));
    arr.sort((a,b) => ord === 'desc' ? b.indice - a.indice : a.indice - b.indice);

    let html = `<table><thead>
      <tr><th>Cripto</th><th>Precio</th><th>√çndice</th><th>Alerta</th></tr>
    </thead><tbody>`;

    for (let d of arr) {
      const cls = d.indice >= 8 ? 'high' : d.indice >= 5 ? 'mid' : 'low';
      html += `<tr>
        <td>${d.cripto}</td>
        <td>${d.precio.toFixed(4)}</td>
        <td class="${cls}">${d.indice}</td>
        <td>${d.alerta}</td>
      </tr>`;
    }

    html += `</tbody></table>`;
    document.getElementById('panel').innerHTML = html;
  }

  function mostrarAlerta() {
    const al = document.getElementById('alerta');
    const n = dataGlobal.find(d => d.indice >= 7 && !alerted.has(d.cripto));
    if (n) {
      alerted.add(n.cripto);
      al.innerText = n.alerta;
      al.style.display = 'block';
      new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
      setTimeout(() => al.style.display = 'none', 10000);
    }
  }

  document.getElementById('buscar').addEventListener('input', renderTabla);
  document.getElementById('orden').addEventListener('change', renderTabla);

  // Primera carga y cada 30s
  actualizar();
  setInterval(actualizar, 30000);
</script>
